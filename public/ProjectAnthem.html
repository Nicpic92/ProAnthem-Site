<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Anthem - Block Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
    <style>
        body { font-family: Inter, system-ui, sans-serif; background-color: #242424; color: rgba(255, 255, 255, 0.87); }
        .form-input, .form-select, .form-textarea { background: #2f2f2f; border: 1px solid #555; border-radius: 6px; padding: 0.5rem 1rem; color: white; width: 100%; }
        .live-preview { font-family: 'Courier New', Courier, monospace; line-height: 1.6; white-space: pre; background-color: #1e1e1e; padding: 1rem; border-radius: 6px; border: 1px solid #4a4a4a; }
        .live-preview-chords { color: #f2c94c; }
        .tab-preview { margin-top: 1rem; border-top: 1px dashed #4a4a4a; padding-top: 1rem; color: #a5b4fc; }
        .btn { border: 1px solid transparent; padding: 0.6em 1.2em; font-size: 1em; font-weight: 500; cursor: pointer; transition: background-color 0.25s; border-radius: 8px; }
        .btn-sm { padding: 0.3em 0.8em; font-size: 0.9em; }
        .btn-primary { background-color: #535bf2; color: white; } .btn-primary:hover { background-color: #646cff; }
        .btn-secondary { background-color: #4b5563; color: white; } .btn-secondary:hover { background-color: #6b7280; }
        .btn-danger { background-color: #b91c1c; color: white; } .btn-danger:hover { background-color: #dc2626; }
        .hidden { display: none; }
        .song-block { background-color: #2d3748; border: 1px solid #4a5568; border-radius: 8px; margin-bottom: 1rem; }
        .block-header { background-color: #4a5568; padding: 0.5rem 1rem; display: flex; justify-content: space-between; align-items: center; cursor: grab; border-top-left-radius: 7px; border-top-right-radius: 7px; }
        .block-header:active { cursor: grabbing; }
        .block-content { padding: 1rem; }
        .fretboard-wrapper { overflow-x: auto; border: 1px solid #555; border-radius: 6px; }
        #fretboard-container { user-select: none; }
        .fretboard-string { stroke: #9ca3af; stroke-width: 2px; }
        .fretboard-note { fill: #facc15; cursor: pointer; }
        .fretboard-note-text { fill: #111827; font-weight: bold; pointer-events: none; }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- Access Denied Message -->
    <div id="access-denied" class="hidden text-center p-20">
        <h2 class="text-3xl font-bold text-red-500">Access Denied</h2>
        <p class="mt-4 text-lg">You must be logged in to use Project Anthem.</p>
        <a href="/proanthem_index.html" class="mt-6 inline-block bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg">Log In or Sign Up</a>
    </div>

    <!-- Main Tool Content -->
    <div id="tool-content" class="max-w-6xl mx-auto hidden">
        <header class="border-b border-gray-700 pb-4 mb-6 flex justify-between items-center">
             <a href="/" class="flex items-center space-x-4">
                <img src="/assets/logo_pa.jpg" alt="ProAnthem Logo" class="h-12">
                <h1 class="text-4xl font-bold">Project Anthem</h1>
            </a>
            <button id="logoutBtn" class="btn btn-secondary">Log Out</button>
        </header>
        <main class="grid grid-cols-1 md:grid-cols-4 gap-8">
            <aside class="md:col-span-1">
                <div class="space-y-6 sticky top-8">
                    <div>
                        <label for="songSelector" class="block text-sm font-medium text-gray-300 mb-1">Load Song</label>
                        <select id="songSelector" class="form-select"></select>
                    </div>
                    <div class="space-y-2">
                        <button id="saveBtn" class="btn btn-primary w-full">Save Song</button>
                        <button id="setlistBtn" class="btn btn-secondary w-full">Setlists</button>
                        <button id="exportPdfBtn" class="btn btn-secondary w-full">Export Song as PDF</button>
                        <button id="deleteBtn" class="btn btn-danger w-full">Delete Song</button>
                        <div id="statusMessage" class="text-center text-sm text-gray-400 h-4"></div>
                    </div>
                     <div class="space-y-3 pt-4 border-t border-gray-700">
                        <h3 class="font-semibold text-lg">Musical Settings</h3>
                        <div class="text-right">
                            <label for="tuningSelector" class="block text-sm font-medium text-gray-400 mb-1">Tuning</label>
                            <select id="tuningSelector" class="form-select form-input text-sm"></select>
                        </div>
                        <div class="text-right">
                            <label for="capoFretInput" class="block text-sm font-medium text-gray-400 mb-1">Capo Fret</label>
                            <input type="number" id="capoFretInput" class="form-input text-sm w-24 ml-auto" value="0" min="0" max="12">
                        </div>
                    </div>
                </div>
            </aside>
            <div class="md:col-span-3 space-y-4">
                <input type="text" id="titleInput" class="form-input text-xl" placeholder="Song Title">
                <input type="text" id="artistInput" class="form-input" placeholder="Artist Name">
                
                <div>
                    <h3 class="text-lg font-semibold mb-2">Live Preview</h3>
                    <div id="livePreview" class="live-preview min-h-[100px]"></div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-2">Song Builder</h3>
                    <div id="song-blocks-container" class="space-y-4">
                        <!-- Song blocks will be rendered here -->
                    </div>
                    <div id="add-block-buttons" class="mt-4 flex flex-wrap gap-2">
                        <!-- Add block buttons are rendered here -->
                    </div>
                </div>
            </div>
        </main>
    </div>
    <!-- Setlist Modal and other modals would go here, unchanged for now -->

    <script>
    // --- GATEKEEPER ---
    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('user_token');
        if (!token) {
            document.getElementById('tool-content').classList.add('hidden');
            document.getElementById('access-denied').classList.remove('hidden');
        } else {
            document.getElementById('tool-content').classList.remove('hidden');
            document.getElementById('access-denied').classList.add('hidden');
            initializeApp();
        }
    });

    function initializeApp() {
        // --- GLOBAL STATE ---
        let songData = {
            id: null,
            title: '',
            artist: '',
            audio_url: null,
            song_blocks: []
        };
        let musicalContext = {
            tuning: 'E_STANDARD',
            capo: 0
        };

        // --- ELEMENT REFS ---
        const titleInput = document.getElementById('titleInput');
        const artistInput = document.getElementById('artistInput');
        const songBlocksContainer = document.getElementById('song-blocks-container');
        const addBlockButtonsContainer = document.getElementById('add-block-buttons');
        const livePreview = document.getElementById('livePreview');
        const tuningSelector = document.getElementById('tuningSelector');
        const capoFretInput = document.getElementById('capoFretInput');
        const songSelector = document.getElementById('songSelector');
        const saveBtn = document.getElementById('saveBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const statusMessage = document.getElementById('statusMessage');

        // --- CONSTANTS ---
        const TUNINGS = { E_STANDARD: { name: "E Standard", offset: 0 }, EB_STANDARD: { name: "Eb Standard", offset: -1 }, D_STANDARD: { name: "D Standard", offset: -2 }, DROP_D: { name: "Drop D", offset: 0 }, DROP_C: { name: "Drop C", offset: -2 } };
        const STRING_NAMES = ['e', 'B', 'G', 'D', 'A', 'E'];
        const FRETBOARD_CONFIG = { frets: 24, width: 8000, height: 180, stringSpacing: 28, fretSpacing: 80, nutWidth: 15, dotFrets: [3, 5, 7, 9, 12, 15, 17, 19, 21, 24], dotRadius: 5, noteRadius: 11 };

        // --- API OBJECT (UNCHANGED FROM PREVIOUS) ---
        const api = { 
            request: async (endpoint, options = {}) => {
                const token = localStorage.getItem('user_token');
                if (!token) { setStatus('You are not logged in.', true); window.location.href = '/proanthem_index.html'; throw new Error('No token found'); }
                const url = `/api${endpoint}`;
                const config = { headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`}, ...options };
                const response = await fetch(url, config);
                if (!response.ok) {
                    if (response.status === 401) { setStatus('Session expired. Please log in.', true); localStorage.removeItem('user_token'); window.location.href = '/proanthem_index.html'; }
                    const err = await response.json().catch(() => ({ message: 'API Error' })); throw new Error(err.message);
                }
                return response.status === 204 ? null : response.json();
            },
            getSheets: () => api.request('/lyric-sheets', { method: 'GET' }),
            getSheet: (id) => api.request(`/lyric-sheets/${id}`, { method: 'GET' }),
            createSheet: (data) => api.request('/lyric-sheets', { method: 'POST', body: JSON.stringify(data) }),
            updateSheet: (id, data) => api.request(`/lyric-sheets/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
            deleteSheet: (id) => api.request(`/lyric-sheets/${id}`, { method: 'DELETE' })
        };
        
        // --- CORE RENDERING & LOGIC ---
        function renderSongBlocks() {
            songBlocksContainer.innerHTML = '';
            songData.song_blocks.forEach(block => {
                const blockEl = createBlockElement(block);
                songBlocksContainer.appendChild(blockEl);
            });
            renderAddBlockButtons();
            renderPreview();
            initializeSortable();
        }

        function createBlockElement(block) {
            const div = document.createElement('div');
            div.className = 'song-block';
            div.dataset.blockId = block.id;

            let contentHtml = '';
            if (block.type === 'lyrics') {
                contentHtml = `<textarea class="form-input" style="min-height: 150px;" data-field="content" placeholder="Enter lyrics and [chords]...">${block.content || ''}</textarea>`;
            } else if (block.type === 'tab') {
                contentHtml = `<div class="fretboard-wrapper"><div id="fretboard-${block.id}"></div></div>`;
            } else if (block.type === 'reference') {
                const originalBlock = songData.song_blocks.find(b => b.id === block.originalId);
                contentHtml = `<div class="p-4 bg-gray-800 rounded-md text-gray-400 italic">Reference to: ${originalBlock ? originalBlock.label : 'Unknown Section'}</div>`;
            }

            div.innerHTML = `
                <div class="block-header">
                    <div class="flex items-center gap-2">
                        <span class="font-bold">${block.label}</span>
                        <span class="text-xs text-gray-400">(${block.type})</span>
                    </div>
                    <div>
                        <button class="btn-sm text-xs hover:underline" data-action="edit-label">Rename</button>
                        <button class="btn-sm text-red-400 hover:underline" data-action="delete">Delete</button>
                    </div>
                </div>
                <div class="block-content">${contentHtml}</div>
            `;
            
            // Post-render initialization for complex elements
            if (block.type === 'tab') {
                setTimeout(() => drawFretboard(block.id), 0);
            }

            return div;
        }

        function renderAddBlockButtons() {
            const createdSections = songData.song_blocks.filter(b => b.type !== 'reference');
            let referenceButtonsHtml = '';
            if (createdSections.length > 0) {
                referenceButtonsHtml = `
                    <div class="relative inline-block text-left">
                        <button id="insert-ref-btn" class="btn btn-secondary">Insert Existing Section</button>
                        <div id="ref-dropdown" class="hidden origin-top-right absolute left-0 mt-2 w-56 rounded-md shadow-lg bg-gray-700 ring-1 ring-black ring-opacity-5 z-10">
                            <div class="py-1" role="menu" aria-orientation="vertical">
                                ${createdSections.map(b => `<a href="#" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600" data-original-id="${b.id}" role="menuitem">${b.label}</a>`).join('')}
                            </div>
                        </div>
                    </div>`;
            }

            addBlockButtonsContainer.innerHTML = `
                <button class="btn btn-secondary" data-action="add" data-type="lyrics"> + Verse </button>
                <button class="btn btn-secondary" data-action="add" data-type="lyrics"> + Chorus </button>
                <button class="btn btn-secondary" data-action="add" data-type="lyrics"> + Bridge </button>
                <button class="btn btn-secondary" data-action="add" data-type="tab"> + Tab Section </button>
                ${referenceButtonsHtml}
            `;
        }
        
        function renderPreview() {
            let previewHtml = '';
            songData.song_blocks.forEach(block => {
                let blockToRender = block;
                if (block.type === 'reference') {
                    blockToRender = songData.song_blocks.find(b => b.id === block.originalId) || block;
                }
                
                previewHtml += `<h4 class="text-lg font-bold mt-4 text-gray-400">${block.label}</h4>`;
                
                if (blockToRender.type === 'lyrics') {
                    const lines = (blockToRender.content || '').split('\n');
                    lines.forEach(line => {
                        const parsed = parseLineForRender(line);
                        previewHtml += `<div class="live-preview-chords">${parsed.chordLine}</div><div>${parsed.lyricLine}</div>`;
                    });
                } else if (blockToRender.type === 'tab') {
                    previewHtml += `<div class="tab-preview">${renderTransposedTab(blockToRender.data || { notes: [] })}</div>`;
                }
            });
            livePreview.innerHTML = previewHtml;
        }

        // --- FRETBOARD LOGIC (scoped to a block) ---
        function drawFretboard(blockId) {
            const container = document.getElementById(`fretboard-${blockId}`);
            if (!container) return;
            const block = songData.song_blocks.find(b => b.id === blockId);
            if (!block) return;
            const { frets, width, height, stringSpacing, fretSpacing, nutWidth, dotFrets, dotRadius } = FRETBOARD_CONFIG;
            let svgHTML = `<svg id="fretboard-svg-${blockId}" width="${width}" height="${height}" style="min-width: 100%;">`;
            svgHTML += `<rect class="fretboard-bg" width="${width}" height="${height}" />`;
            svgHTML += `<g id="fretboard-notes-group-${blockId}"></g>`; // Notes go here to be under strings
            for (let i = 0; i < 6; i++) {
                const y = stringSpacing / 2 + i * stringSpacing;
                svgHTML += `<line class="fretboard-string" x1="0" y1="${y}" x2="${width}" y2="${y}" />`;
            }
            svgHTML += `<rect class="fretboard-nut" x="0" y="0" width="${nutWidth}" height="${height}" />`;
            for (let i = 1; i <= frets; i++) {
                const x = nutWidth + i * fretSpacing;
                svgHTML += `<line class="fretboard-fret" x1="${x}" y1="0" x2="${x}" y2="${height}" stroke="#4a5563" stroke-width="1" />`;
            }
            dotFrets.forEach(fret => {
                const x = nutWidth + (fret - 0.5) * fretSpacing;
                if (fret % 12 === 0) {
                    svgHTML += `<circle class="fretboard-dot" cx="${x}" cy="${stringSpacing * 1.5}" r="${dotRadius}" />`;
                    svgHTML += `<circle class="fretboard-dot" cx="${x}" cy="${stringSpacing * 4.5}" r="${dotRadius}" />`;
                } else {
                    svgHTML += `<circle class="fretboard-dot" cx="${x}" cy="${height / 2}" r="${dotRadius}" />`;
                }
            });
            svgHTML += `<rect id="fretboard-target-zone-${blockId}" x="0" y="0" width="${width}" height="${height}" fill="transparent" class="fretboard-target-zone" />`;
            svgHTML += `</svg>`;
            container.innerHTML = svgHTML;
            drawNotesOnFretboard(blockId);
        }

        function drawNotesOnFretboard(blockId) {
            const block = songData.song_blocks.find(b => b.id === blockId);
            const notesGroup = document.getElementById(`fretboard-notes-group-${blockId}`);
            if (!notesGroup || !block || block.type !== 'tab') return;
            notesGroup.innerHTML = '';
            
            const totalOffset = (TUNINGS[musicalContext.tuning]?.offset ?? 0) + musicalContext.capo;

            (block.data?.notes || []).forEach((note, index) => {
                const transposedFret = note.fret - totalOffset;
                if (transposedFret < 0) return;

                const y = FRETBOARD_CONFIG.stringSpacing / 2 + note.string * FRETBOARD_CONFIG.stringSpacing;
                const x = (transposedFret === 0) 
                    ? FRETBOARD_CONFIG.nutWidth / 2 
                    : FRETBOARD_CONFIG.nutWidth + (transposedFret - 0.5) * FRETBOARD_CONFIG.fretSpacing + note.position;
                
                notesGroup.innerHTML += `
                    <g>
                        <circle class="fretboard-note" cx="${x}" cy="${y}" r="${FRETBOARD_CONFIG.noteRadius}" data-note-index="${index}" data-block-id="${blockId}" />
                        <text class="fretboard-note-text" x="${x}" y="${y+1}">${transposedFret}</text>
                    </g>
                `;
            });
        }
        
        function getFretFromClick(evt, blockId) {
            const svg = document.getElementById(`fretboard-svg-${blockId}`);
            if (!svg) return null;
            const pt = svg.createSVGPoint();
            pt.x = evt.clientX; pt.y = evt.clientY;
            const svgPoint = pt.matrixTransform(svg.getScreenCTM().inverse());
            
            const stringIndex = Math.floor((svgPoint.y / FRETBOARD_CONFIG.stringSpacing));
            const fret = Math.round((svgPoint.x - FRETBOARD_CONFIG.nutWidth) / FRETBOARD_CONFIG.fretSpacing);
            
            if (stringIndex >= 0 && stringIndex < 6 && fret >= 0 && fret <= FRETBOARD_CONFIG.frets) {
                return { string: stringIndex, fret, position: svgPoint.x - (FRETBOARD_CONFIG.nutWidth + (fret - 0.5) * FRETBOARD_CONFIG.fretSpacing) };
            }
            return null;
        }

        function renderTransposedTab(tabBlockData) {
            if (!tabBlockData || !tabBlockData.notes || tabBlockData.notes.length === 0) return 'No tab data for this section.';
            const totalOffset = (TUNINGS[musicalContext.tuning]?.offset ?? 0) + musicalContext.capo;
            
            const positionMap = new Map();
            tabBlockData.notes.forEach(note => {
                const transposedFret = note.fret - totalOffset;
                if (transposedFret < 0) return;
                const charPosition = Math.floor(note.position / 10);
                if (!positionMap.has(charPosition)) {
                    positionMap.set(charPosition, Array(6).fill(null));
                }
                positionMap.get(charPosition)[note.string] = transposedFret;
            });
            
            if (positionMap.size === 0) return 'Notes out of range for current settings.';
            
            const sortedPositions = [...positionMap.keys()].sort((a,b) => a - b);
            const lines = STRING_NAMES.map(name => `${name}|`);
            let lastCharPos = 1;
            
            sortedPositions.forEach(charPos => {
                const notesAtPos = positionMap.get(charPos);
                const padding = charPos - lastCharPos;
                if (padding > 0) lines.forEach((line, i) => lines[i] += '-'.repeat(padding));
                
                let maxFretWidth = 0;
                notesAtPos.forEach(fret => {
                    if (fret !== null) maxFretWidth = Math.max(maxFretWidth, String(fret).length);
                });
                
                lines.forEach((line, i) => {
                    const fret = notesAtPos[i];
                    lines[i] += (fret !== null) ? String(fret).padEnd(maxFretWidth, '-') : '-'.repeat(maxFretWidth);
                });
                lastCharPos = charPos + maxFretWidth;
            });
            
            const maxLength = Math.max(...lines.map(l => l.length));
            return lines.map(line => line.padEnd(maxLength, '-')).join('\n');
        }

        // --- DATA HANDLING ---
        function updateBlockData(blockId, field, value) {
            const block = songData.song_blocks.find(b => b.id === blockId);
            if (block) {
                block[field] = value;
                renderPreview();
            }
        }
        
        async function loadSong(id) {
            if (!id) { initializeNewSong(); return; }
            setStatus('Loading song...');
            try {
                const data = await api.getSheet(id);
                songData = {
                    id: data.id,
                    title: data.title || '',
                    artist: data.artist || '',
                    audio_url: data.audio_url,
                    song_blocks: data.song_blocks || []
                };
                titleInput.value = songData.title;
                artistInput.value = songData.artist;
                renderSongBlocks();
                setStatus('Song loaded.');
            } catch (error) {
                setStatus(`Error loading song: ${error.message}`, true);
                initializeNewSong();
            }
        }

        function initializeNewSong() {
            songData = {
                id: null, title: '', artist: '', audio_url: null,
                song_blocks: [{
                    id: `block_${Date.now()}`,
                    type: 'lyrics',
                    label: 'Verse 1',
                    content: ''
                }]
            };
            titleInput.value = '';
            artistInput.value = '';
            songSelector.value = 'new';
            renderSongBlocks();
        }

        async function handleSave() {
            songData.title = titleInput.value || 'Untitled';
            songData.artist = artistInput.value || 'Unknown Artist';
            setStatus('Saving...');
            try {
                const payload = { ...songData };
                const savedSong = songData.id ? await api.updateSheet(songData.id, payload) : await api.createSheet(payload);
                songData.id = savedSong.id;
                setStatus('Saved successfully!');
                if (!songSelector.querySelector(`option[value="${savedSong.id}"]`)) { 
                    await loadSheetList();
                    songSelector.value = savedSong.id;
                }
            } catch (error) { setStatus(`Save failed: ${error.message}`, true); }
        }
        
        // --- EVENT LISTENERS ---
        titleInput.addEventListener('input', () => songData.title = titleInput.value);
        artistInput.addEventListener('input', () => songData.artist = artistInput.value);
        tuningSelector.addEventListener('input', () => { musicalContext.tuning = tuningSelector.value; renderSongBlocks(); });
        capoFretInput.addEventListener('input', () => { musicalContext.capo = parseInt(capoFretInput.value, 10) || 0; renderSongBlocks(); });
        songSelector.addEventListener('change', () => loadSong(songSelector.value === 'new' ? null : songSelector.value));
        saveBtn.addEventListener('click', handleSave);
        logoutBtn.addEventListener('click', () => { localStorage.removeItem('user_token'); localStorage.removeItem('userRole'); window.location.href = '/proanthem_index.html'; });

        songBlocksContainer.addEventListener('input', e => {
            if (e.target.dataset.field) {
                const blockId = e.target.closest('.song-block').dataset.blockId;
                updateBlockData(blockId, e.target.dataset.field, e.target.value);
            }
        });

        songBlocksContainer.addEventListener('click', e => {
            const blockEl = e.target.closest('.song-block');
            if (!blockEl) return;
            const blockId = blockEl.dataset.blockId;

            if (e.target.dataset.action === 'delete') {
                if (confirm('Are you sure you want to delete this section?')) {
                    songData.song_blocks = songData.song_blocks.filter(b => b.id !== blockId);
                    // Also remove references to this block
                    songData.song_blocks = songData.song_blocks.filter(b => b.type !== 'reference' || b.originalId !== blockId);
                    renderSongBlocks();
                }
            } else if (e.target.dataset.action === 'edit-label') {
                const block = songData.song_blocks.find(b => b.id === blockId);
                const newLabel = prompt('Enter new section label:', block.label);
                if (newLabel) {
                    block.label = newLabel;
                    renderSongBlocks();
                }
            }
        });
        
        fretboardContainer.addEventListener('click', e => {
            const blockId = e.target.closest('.song-block')?.dataset.blockId;
            if(!blockId) return;
            // ... fretboard click logic
        });
        
        addBlockButtonsContainer.addEventListener('click', e => {
            const target = e.target;
            if (target.id === 'insert-ref-btn') {
                document.getElementById('ref-dropdown').classList.toggle('hidden');
            } else if (target.parentElement.id === 'ref-dropdown') {
                const originalId = target.dataset.originalId;
                const originalBlock = songData.song_blocks.find(b => b.id === originalId);
                if(originalBlock) {
                    songData.song_blocks.push({
                        id: `block_${Date.now()}`,
                        type: 'reference',
                        label: `Reference to ${originalBlock.label}`,
                        originalId: originalId
                    });
                    renderSongBlocks();
                }
                document.getElementById('ref-dropdown').classList.add('hidden');
            } else if (target.dataset.action === 'add') {
                const type = target.dataset.type;
                const count = songData.song_blocks.filter(b => b.type === 'lyrics').length + 1;
                const label = `${target.textContent.trim()} ${count}`;
                const newBlock = { id: `block_${Date.now()}`, type, label };
                if (type === 'lyrics') newBlock.content = '';
                if (type === 'tab') newBlock.data = { notes: [] };
                songData.song_blocks.push(newBlock);
                renderSongBlocks();
            }
        });

        function initializeSortable() {
            new Sortable(songBlocksContainer, {
                animation: 150,
                handle: '.block-header',
                onEnd: (evt) => {
                    const { oldIndex, newIndex } = evt;
                    const [movedItem] = songData.song_blocks.splice(oldIndex, 1);
                    songData.song_blocks.splice(newIndex, 0, movedItem);
                    renderPreview(); // Update preview with new order
                }
            });
        }
        
        // --- UTILITY & UNCHANGED FUNCTIONS ---
        function setStatus(message, isError = false) { statusMessage.textContent = message; statusMessage.style.color = isError ? '#ef4444' : '#9ca3af'; if (message) setTimeout(() => statusMessage.textContent = '', 3000); }
        function parseLineForRender(rawLine) { let chordLine = ''; let lyricLine = ''; const regex = /(\[[^\]]+\])|([^\[]+)/g; let match; if (!rawLine.trim()) return { chordLine: '&nbsp;', lyricLine: '&nbsp;' }; while ((match = regex.exec(rawLine)) !== null) { if (match[1]) { const chordName = match[1].slice(1, -1); chordLine += chordName; lyricLine += ' '.repeat(chordName.length); } if (match[2]) { chordLine += ' '.repeat(match[2].length); lyricLine += match[2]; } } return { chordLine: chordLine.trimEnd() || '&nbsp;', lyricLine: lyricLine.trimEnd() || '&nbsp;' }; }
        function populateTuningSelector() { for (const key in TUNINGS) { const option = document.createElement('option'); option.value = key; option.textContent = TUNINGS[key].name; tuningSelector.appendChild(option); } }
        async function loadSheetList() { try { const songs = await api.getSheets(); songs.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at)); songSelector.innerHTML = '<option value="new">-- Create New Song --</option>'; songs.forEach(s => { const o = document.createElement('option'); o.value = s.id; o.textContent = s.title || 'Untitled'; songSelector.appendChild(o); }); } catch (e) { setStatus('Failed to load songs.', true); } }


        // --- INITIAL LOAD ---
        (function(){
            populateTuningSelector(); 
            loadSheetList();
            initializeNewSong();
        })();
    }
    </script>
</body>
</html>
