<!-- START OF FILE public/Band.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Band Management - ProAnthem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .tab-button {
            background-color: transparent;
            border-bottom: 2px solid transparent;
        }
        .tab-button.active {
            border-bottom-color: #dc2626; /* red-600 */
            color: #f3f4f6; /* gray-100 */
        }
    </style>
</head>
<body class="tool flex flex-col min-h-screen">

    <header class="container mx-auto p-6 flex justify-between items-center">
        <a href="/proanthem_index.html" class="flex items-center space-x-4">
            <img src="/assets/logo_pa.jpg" alt="ProAnthem Logo" class="h-12">
            <h1 class="text-4xl font-bold">ProAnthem</h1>
        </a>
        <div id="nav-auth-section">
             <!-- Populated by auth script -->
        </div>
    </header>

    <main class="container mx-auto px-6 py-12 flex-grow">
        <div id="band-content" style="display: none;">
            <div class="flex flex-col md:flex-row justify-between md:items-center gap-4">
                 <div>
                    <h1 id="band-name-header" class="text-4xl font-bold">Your Band</h1>
                    <p id="band-id-display" class="text-lg text-gray-400 mt-2">Loading band info...</p>
                 </div>
                 <a href="/ProjectAnthem.html" class="btn btn-secondary w-full md:w-auto">‚Üê Back to Tool</a>
            </div>

            <!-- Tab Navigation -->
            <div class="mt-8 border-b border-gray-700">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button class="tab-button active text-gray-400 hover:text-gray-200" data-tab="members">Members</button>
                    <button class="tab-button text-gray-400 hover:text-gray-200" data-tab="profile">Public Profile</button>
                    <button class="tab-button text-gray-400 hover:text-gray-200" data-tab="calendar">Calendar</button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="tab-content-members" class="tab-content mt-8">
                <div class="bg-gray-900 p-6 rounded-lg shadow-md">
                     <h2 class="text-2xl font-bold mb-4">Add New Band Member</h2>
                     <form id="add-member-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <input type="text" id="new-member-firstname" required class="form-input p-2 rounded-md" placeholder="First Name">
                        <input type="text" id="new-member-lastname" required class="form-input p-2 rounded-md" placeholder="Last Name">
                        <input type="email" id="new-member-email" required class="form-input p-2 rounded-md" placeholder="Email Address">
                         <div class="md:col-span-3 text-right">
                            <button type="submit" class="btn btn-primary w-full md:w-auto px-6 py-2">Create Invite Link</button>
                         </div>
                     </form>
                     <div id="add-member-status-container" class="mt-3 hidden">
                        <p id="add-member-status" class="text-sm h-5"></p>
                        <div id="invite-link-container" class="mt-2 hidden">
                            <p class="text-sm text-gray-300">Send this link to the new member:</p>
                            <input type="text" id="invite-link-input" readonly class="form-input w-full mt-1 bg-gray-800 text-yellow-300 cursor-pointer">
                            <button id="copy-link-btn" class="btn btn-sm btn-secondary mt-2">Copy Link</button>
                        </div>
                     </div>
                </div>
                <div class="mt-12 bg-gray-900 p-8 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Current Members</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-800">
                                <tr>
                                    <th class="p-3 text-left font-semibold">Email</th>
                                    <th class="p-3 text-left font-semibold">Name</th>
                                    <th class="p-3 text-left font-semibold">Role</th>
                                    <th class="p-3 text-left font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="members-table-body" class="bg-gray-800/50"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-content-profile" class="tab-content mt-8 hidden">
                <form id="profile-form" class="bg-gray-900 p-8 rounded-lg shadow-md space-y-6">
                    <h2 class="text-2xl font-bold">Edit Public Profile</h2>
                    <p class="text-gray-400">This information will be displayed on your public band page. Fill out as much as you'd like.</p>
                    
                    <div>
                        <label for="profile-band-name" class="block text-sm font-medium">Band Name</label>
                        <input type="text" id="profile-band-name" name="band_name" class="form-input mt-1">
                    </div>
                    <div>
                        <label for="profile-slug" class="block text-sm font-medium">Custom URL Slug</label>
                        <div class="flex items-center mt-1">
                            <span class="text-gray-400 bg-gray-800 p-2 rounded-l-md border border-r-0 border-gray-600">proanthem.com/bands/</span>
                            <input type="text" id="profile-slug" name="slug" class="form-input rounded-l-none" placeholder="your-band-name">
                        </div>
                    </div>
                    <div>
                        <label for="profile-bio" class="block text-sm font-medium">Band Bio</label>
                        <textarea id="profile-bio" name="bio" rows="5" class="form-input mt-1"></textarea>
                    </div>

                    <h3 class="text-xl font-bold pt-4 border-t border-gray-700">Links</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- --- FIX: Changed type="url" to type="text" for the main website link --- -->
                        <input type="text" name="link_website" class="form-input" placeholder="https://yourwebsite.com">
                        <input type="url" name="link_spotify" class="form-input" placeholder="Spotify URL">
                        <input type="url" name="link_apple_music" class="form-input" placeholder="Apple Music URL">
                        <input type="url" name="link_youtube" class="form-input" placeholder="YouTube URL">
                        <input type="url" name="link_instagram" class="form-input" placeholder="Instagram URL">
                        <input type="url" name="link_facebook" class="form-input" placeholder="Facebook URL">
                    </div>
                    
                    <div class="flex items-center pt-4 border-t border-gray-700">
                        <input type="checkbox" id="profile-enabled" name="press_kit_enabled" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-indigo-600 focus:ring-indigo-500">
                        <label for="profile-enabled" class="ml-3 text-sm font-medium">Enable Public Page</label>
                    </div>

                    <div class="text-right">
                        <button type="submit" class="btn btn-primary">Save Profile</button>
                    </div>
                </form>
            </div>
            
            <div id="tab-content-calendar" class="tab-content mt-8 hidden">
                 <div class="bg-gray-900 p-8 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">Band Calendar</h2>
                        <button id="add-event-btn" class="btn btn-primary">Add Event</button>
                    </div>
                    <div id="calendar-event-list" class="space-y-4">
                        <!-- Events will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <div id="access-denied" class="text-center py-20" style="display: none;">
            <h2 class="text-3xl font-bold text-red-500">Access Denied</h2>
            <p class="mt-4 text-lg text-gray-300">You must be a Band Admin to view this page.</p>
            <a href="/ProjectAnthem.html" class="btn btn-primary mt-6">Return to the Tool</a>
        </div>
    </main>

    <div id="event-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 id="event-modal-title" class="text-2xl font-bold">Add Event</h2>
            <form id="event-form" class="space-y-4 mt-4">
                <input type="hidden" id="event-id" name="id">
                <input type="text" name="title" required class="form-input" placeholder="Event Title (e.g., Rehearsal, Gig at The Venue)">
                <input type="datetime-local" name="event_date" required class="form-input">
                <input type="text" name="venue_name" class="form-input" placeholder="Venue Name">
                <textarea name="details" rows="3" class="form-input" placeholder="Private Notes (Load-in times, etc.)"></textarea>
                
                <div class="pt-4 border-t border-gray-700">
                    <div class="flex items-center">
                        <input type="checkbox" id="event-public" name="is_public" class="h-4 w-4 rounded bg-gray-700 text-indigo-600">
                        <label for="event-public" class="ml-3 text-sm font-medium">Make this event public on my band page</label>
                    </div>
                    <div id="public-event-fields" class="mt-4 space-y-4 hidden">
                         <input type="url" name="external_url" class="form-input" placeholder="Public Info/Ticket URL (e.g., Facebook event)">
                    </div>
                </div>

                <div class="flex justify-between items-center pt-4 border-t border-gray-700">
                    <div>
                        <button type="button" id="delete-event-btn" class="btn btn-danger hidden">Delete</button>
                    </div>
                    <div class="flex gap-4">
                        <button type="button" id="cancel-event-btn" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Event</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <footer class="text-center py-6 text-gray-500">
        <p>&copy; 2025 ProAnthem. A Spreadsheet Simplicity Product.</p>
    </footer>

    <script type="module" src="/js/auth.js"></script>
    <script type="module">
        import { checkAccess } from './js/auth.js';
        import { 
            getBandDetails, getBandMembers, addBandMember, removeBandMember,
            getBandProfile, updateBandProfile,
            getCalendarEvents, createCalendarEvent, updateCalendarEvent, deleteCalendarEvent
        } from './js/api.js';
        
        document.addEventListener('DOMContentLoaded', () => {
            if (checkAccess()) {
                initializeBandPage();
            }
        });

        function initializeBandPage() {
            // ... other initializations are correct ...
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    contents.forEach(c => c.classList.add('hidden'));
                    document.getElementById(`tab-content-${tab.dataset.tab}`).classList.remove('hidden');
                });
            });

            loadBandDetails();
            loadBandMembers();
            document.getElementById('add-member-form').addEventListener('submit', handleAddMember);
            document.getElementById('copy-link-btn').addEventListener('click', copyInviteLink);
            
            loadBandProfile();
            document.getElementById('profile-form').addEventListener('submit', handleSaveProfile);
            
            loadCalendarEvents();
            document.getElementById('add-event-btn').addEventListener('click', () => openEventModal(null));
            document.getElementById('event-public').addEventListener('change', togglePublicEventFields);
            document.getElementById('event-form').addEventListener('submit', handleSaveEvent);
            document.getElementById('cancel-event-btn').addEventListener('click', closeEventModal);
            document.getElementById('delete-event-btn').addEventListener('click', handleDeleteEvent);
        }

        async function loadBandDetails() {
            const nameHeader = document.getElementById('band-name-header');
            const idDisplay = document.getElementById('band-id-display');
            try {
                const details = await getBandDetails();
                nameHeader.textContent = details.band_name || 'Your Band';
                idDisplay.textContent = `Band Number: ${details.band_number || 'N/A'}`;
            } catch(error) {
                idDisplay.textContent = `Could not load band info.`;
            }
        }
        
        async function loadBandMembers() {
            // ... this function is correct ...
            const tableBody = document.getElementById('members-table-body');
            tableBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center">Loading...</td></tr>`;
            try {
                const members = await getBandMembers();
                tableBody.innerHTML = '';
                members.forEach(member => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-700';
                    const name = (member.first_name && member.last_name) ? `${member.first_name} ${member.last_name}` : 'Pending Signup';
                    const roleDisplay = member.role.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    let actionsHtml = (member.role !== 'band_admin' && member.role !== 'admin') ? `<button class="btn-sm text-red-400 hover:underline" data-email="${member.email}">Remove</button>` : '';
                    row.innerHTML = `<td class="p-3">${member.email}</td><td class="p-3 text-gray-400">${name}</td><td class="p-3 text-gray-400">${roleDisplay}</td><td class="p-3">${actionsHtml}</td>`;
                    const removeBtn = row.querySelector('button[data-email]');
                    if (removeBtn) {
                        removeBtn.addEventListener('click', () => removeMember(member.email));
                    }
                    tableBody.appendChild(row);
                });
            } catch (error) {
                 tableBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">Failed to load members: ${error.message}</td></tr>`;
            }
        }
        
        async function handleAddMember(event) {
            // ... this function is correct ...
            event.preventDefault();
            const statusContainer = document.getElementById('add-member-status-container');
            const statusEl = document.getElementById('add-member-status');
            const inviteLinkContainer = document.getElementById('invite-link-container');
            const inviteLinkInput = document.getElementById('invite-link-input');
            statusContainer.classList.remove('hidden');
            inviteLinkContainer.classList.add('hidden');
            statusEl.textContent = 'Creating invite link...';
            statusEl.className = 'text-sm h-5 text-yellow-400';
            const button = event.target.querySelector('button');
            button.disabled = true;
            const payload = {
                firstName: document.getElementById('new-member-firstname').value,
                lastName: document.getElementById('new-member-lastname').value,
                email: document.getElementById('new-member-email').value,
            };
            try {
                const result = await addBandMember(payload);
                statusEl.textContent = result.message;
                statusEl.className = 'text-sm h-5 text-green-400';
                inviteLinkInput.value = result.link;
                inviteLinkContainer.classList.remove('hidden');
                event.target.reset();
            } catch(error) {
                statusEl.textContent = `Error: ${error.message}`;
                statusEl.className = 'text-sm h-5 text-red-500';
            } finally {
                 button.disabled = false;
            }
        }

        function copyInviteLink() {
            // ... this function is correct ...
            const inviteLinkInput = document.getElementById('invite-link-input');
            const copyBtn = document.getElementById('copy-link-btn');
            inviteLinkInput.select();
            document.execCommand('copy');
            copyBtn.textContent = 'Copied!';
            setTimeout(() => { copyBtn.textContent = 'Copy Link'; }, 2000);
        }

        async function removeMember(userEmail) {
            // ... this function is correct ...
            if (confirm(`Are you sure you want to remove ${userEmail} from the band? They will lose access immediately.`)) {
                try {
                    await removeBandMember(userEmail);
                    loadBandMembers();
                } catch(error) {
                    alert(`Failed to remove member: ${error.message}`);
                }
            }
        }
        
        async function loadBandProfile() {
            try {
                const profile = await getBandProfile();
                const form = document.getElementById('profile-form');
                for (const key in profile) {
                    if (form.elements[key]) {
                        if (form.elements[key].type === 'checkbox') {
                            form.elements[key].checked = profile[key];
                        } else {
                            form.elements[key].value = profile[key] || '';
                        }
                    }
                }
                // --- FIX: When loading the profile, check if the website URL includes the band's slug ---
                // If it does, it's the auto-generated one, so we should display it differently.
                const websiteInput = form.elements['link_website'];
                if (profile.slug && websiteInput.value.includes(`/bands/${profile.slug}`)) {
                    websiteInput.value = `https://www.proanthem.com/bands/${profile.slug}`;
                    websiteInput.readOnly = true; // Make it non-editable
                    websiteInput.classList.add('bg-gray-800', 'cursor-not-allowed'); // Style as disabled
                } else {
                    websiteInput.readOnly = false;
                    websiteInput.classList.remove('bg-gray-800', 'cursor-not-allowed');
                }

            } catch (error) { alert(`Error loading profile: ${error.message}`); }
        }

        async function handleSaveProfile(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            let payload = Object.fromEntries(formData.entries());
            payload.press_kit_enabled = form.elements['press_kit_enabled'].checked;
            
            // --- FIX: If the website input is readonly, it means it's our auto-generated URL.
            // We should ensure we save this URL correctly.
            const websiteInput = form.elements['link_website'];
            if (websiteInput.readOnly) {
                payload.link_website = `https://www.proanthem.com/bands/${payload.slug}`;
            }

            try {
                await updateBandProfile(payload);
                alert('Profile saved successfully!');
                document.getElementById('band-name-header').textContent = payload.band_name;
                // Reload the profile to reflect changes, like the readonly state.
                loadBandProfile();
            } catch (error) { alert(`Error saving profile: ${error.message}`); }
        }
        
        // ... Calendar functions are correct ...
        async function loadCalendarEvents() {
            const listEl = document.getElementById('calendar-event-list');
            listEl.innerHTML = '<p>Loading events...</p>';
            try {
                const events = await getCalendarEvents();
                listEl.innerHTML = '';
                if (events.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-400">No events scheduled.</p>';
                }
                events.forEach(event => {
                    const eventDate = new Date(event.event_date);
                    const isPast = eventDate < new Date();
                    const eventEl = document.createElement('div');
                    eventEl.className = `p-4 rounded-lg border flex justify-between items-center ${isPast ? 'bg-gray-800 border-gray-700 opacity-60' : 'bg-gray-800/50 border-gray-700'}`;
                    eventEl.innerHTML = `
                        <div>
                            <p class="font-bold">${event.title} <span class="text-sm font-normal px-2 py-0.5 rounded ${event.is_public ? 'bg-blue-600' : 'bg-gray-600'}">${event.is_public ? 'Public' : 'Private'}</span></p>
                            <p class="text-sm text-gray-400">${eventDate.toLocaleString()}</p>
                        </div>
                        <button class="btn btn-secondary btn-sm">Edit</button>
                    `;
                    eventEl.querySelector('button').addEventListener('click', () => openEventModal(event));
                    listEl.appendChild(eventEl);
                });
            } catch (error) {
                 listEl.innerHTML = `<p class="text-red-500">Error loading events: ${error.message}</p>`;
            }
        }

        function openEventModal(event) {
            const modal = document.getElementById('event-modal');
            const form = document.getElementById('event-form');
            form.reset();
            if (event) {
                document.getElementById('event-modal-title').textContent = 'Edit Event';
                form.elements['id'].value = event.id;
                form.elements['title'].value = event.title;
                const d = new Date(event.event_date);
                d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                form.elements['event_date'].value = d.toISOString().slice(0, 16);
                form.elements['venue_name'].value = event.venue_name || '';
                form.elements['details'].value = event.details || '';
                form.elements['is_public'].checked = event.is_public;
                form.elements['external_url'].value = event.external_url || '';
                document.getElementById('delete-event-btn').classList.remove('hidden');
            } else {
                document.getElementById('event-modal-title').textContent = 'Add Event';
                document.getElementById('delete-event-btn').classList.add('hidden');
            }
            togglePublicEventFields();
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeEventModal() { document.getElementById('event-modal').classList.add('hidden'); }
        function togglePublicEventFields() { document.getElementById('public-event-fields').classList.toggle('hidden', !document.getElementById('event-public').checked); }
        
        async function handleSaveEvent(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const payload = Object.fromEntries(formData.entries());
            payload.is_public = form.elements['is_public'].checked;
            payload.id = payload.id ? parseInt(payload.id) : null;
            
            try {
                if (payload.id) {
                    await updateCalendarEvent(payload.id, payload);
                } else {
                    await createCalendarEvent(payload);
                }
                closeEventModal();
                loadCalendarEvents();
            } catch (error) { alert(`Error saving event: ${error.message}`); }
        }

        async function handleDeleteEvent() {
            const eventId = document.getElementById('event-id').value;
            if (!eventId || !confirm('Are you sure you want to delete this event?')) return;
            try {
                await deleteCalendarEvent(eventId);
                closeEventModal();
                loadCalendarEvents();
            } catch (error) { alert(`Error deleting event: ${error.message}`); }
        }
    </script>
</body>
</html>
