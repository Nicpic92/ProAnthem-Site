<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Anthem - Live Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
    <style>
        body { font-family: Inter, system-ui, sans-serif; background-color: #242424; color: rgba(255, 255, 255, 0.87); }
        .form-input, .form-select, .form-textarea { background: #2f2f2f; border: 1px solid #555; border-radius: 6px; padding: 0.5rem 1rem; color: white; width: 100%; resize: none; }
        .live-preview { font-family: 'Courier New', Courier, monospace; line-height: 1.6; white-space: pre; background-color: #1e1e1e; padding: 1rem; border-radius: 6px; border: 1px solid #4a4a4a; }
        .live-preview-chords { color: #f2c94c; }
        .tab-preview { margin-top: 1rem; border-top: 1px dashed #4a4a4a; padding-top: 1rem; color: #a5b4fc; }
        .btn { border: 1px solid transparent; padding: 0.6em 1.2em; font-size: 1em; font-weight: 500; cursor: pointer; transition: background-color 0.25s; border-radius: 8px; }
        .btn:disabled { background-color: #4b5563; opacity: 0.5; cursor: not-allowed; }
        .btn-sm { padding: 0.3em 0.8em; font-size: 0.9em; }
        .btn-primary { background-color: #535bf2; color: white; } .btn-primary:hover:not(:disabled) { background-color: #646cff; }
        .btn-secondary { background-color: #4b5563; color: white; } .btn-secondary:hover:not(:disabled) { background-color: #6b7280; }
        .btn-danger { background-color: #b91c1c; color: white; } .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        .hidden { display: none; }
        .song-block { background-color: #2d3748; border: 1px solid #4a5568; border-radius: 8px; margin-bottom: 1rem; }
        .block-header { background-color: #4a5568; padding: 0.5rem 1rem; display: flex; justify-content: space-between; align-items: center; cursor: grab; border-top-left-radius: 7px; border-top-right-radius: 7px; }
        .block-header:active { cursor: grabbing; }
        .block-content { padding: 1rem; position: relative; padding-bottom: 1.5rem; }
        .fretboard-wrapper { overflow-x: auto; border: 1px solid #555; border-radius: 6px; }
        .fretboard-string { stroke: #9ca3af; stroke-width: 2px; }
        .fretboard-note { fill: #facc15; cursor: grab; transition: fill 0.2s; }
        .fretboard-note:active { cursor: grabbing; }
        .fretboard-note.selected { fill: #ef4444; stroke: white; stroke-width: 2px; }
        .fretboard-note-text { fill: #111827; font-weight: bold; pointer-events: none; text-anchor: middle; alignment-baseline: central; }
        .queue-pill { background-color: #374151; padding: 2px 8px; border-radius: 12px; font-size: 0.9em; }
        .queue-pill.next { background-color: #535bf2; font-weight: bold; }
        .form-textarea.placement-mode { cursor: crosshair; }
        .drum-tab-block { font-family: 'Courier New', Courier, monospace; line-height: 1.5; }
        .resize-handle { position: absolute; bottom: 0; left: 0; right: 0; height: 10px; cursor: ns-resize; border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; background-color: rgba(74, 85, 104, 0.5); }
        .resize-handle:hover { background-color: rgba(99, 110, 129, 0.7); }
        .btn-edit-mode { background-color: #2563eb; } .btn-edit-mode:hover { background-color: #1d4ed8; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background: #2d3748; padding: 2rem; border-radius: 8px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto;}
        .sortable-ghost { opacity: 0.4; background: #4a5568; }
        .sounding-key-box {
            display: inline-block;
            background-color: #1f2937;
            border: 1px solid #4b5563;
            border-radius: 6px;
            padding: 0.5rem 1.5rem;
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* font-bold */
            color: #a5b4fc; /* indigo-300 */
            min-width: 80px;
            text-align: center;
        }
        aside#sidebar > div {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        aside#sidebar > div::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto mb-6 p-4 bg-yellow-900 border border-yellow-600 text-yellow-100 rounded-lg text-center">
        <p class="font-bold">Welcome to the Project Anthem Live Demo!</p>
        <p class="text-sm">Feel free to experiment with all the features. Please note that your work will not be saved.</p>
    </div>

    <div id="tool-content" class="max-w-6xl mx-auto">
        <header class="border-b border-gray-700 pb-4 mb-6 flex justify-between items-center">
             <a href="/proanthem_index.html" class="flex items-center space-x-4">
                <img src="/assets/logo_pa.jpg" alt="ProAnthem Logo" class="h-12">
                <h1 class="text-4xl font-bold">Project Anthem</h1>
            </a>
        </header>
        <main class="grid grid-cols-1 md:grid-cols-4 gap-8">
            <aside id="sidebar" class="md:col-span-1 h-full">
                <div class="sticky top-8 flex flex-col space-y-6 max-h-[90vh] overflow-y-auto pr-2">
                    <div class="space-y-2 flex-shrink-0">
                        <label class="block text-sm font-medium text-gray-300 mb-1">Demo Controls</label>
                        <button id="saveBtn" class="btn btn-primary w-full">Save Song</button>
                        <button id="importBtn" class="btn btn-secondary w-full">Import Song</button>
                        <a href="/proanthem_index.html" class="btn btn-secondary w-full text-center block">Sign Up to Save</a>
                        <button id="resetDemoBtn" class="btn btn-danger w-full">Reset Demo</button>
                        <div id="statusMessage" class="text-center text-sm text-gray-400 h-4"></div>
                    </div>
                    <div class="space-y-6 flex-shrink-0">
                        <div class="space-y-3 pt-4 border-t border-gray-700">
                            <h3 class="font-semibold text-lg">Chord Palette</h3>
                            <p class="text-xs text-gray-400">Click to insert. Ctrl/Cmd+Click to add to queue.</p>
                            <div id="chordPalette" class="flex flex-wrap gap-2"></div>
                        </div>
                        <div class="space-y-3 pt-4 border-t border-gray-700">
                            <h3 class="font-semibold text-lg">Musical Settings</h3>
                            <div class="space-y-2 text-right">
                                <div>
                                    <label for="tuningSelector" class="block text-sm font-medium text-gray-400 mb-1">Tuning</label>
                                    <select id="tuningSelector" class="form-select form-input text-sm"></select>
                                </div>
                                <div>
                                    <label for="capoFretInput" class="block text-sm font-medium text-gray-400 mb-1">Capo Fret</label>
                                    <input type="number" id="capoFretInput" class="form-input text-sm w-24 ml-auto" value="0" min="0" max="12">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-1">Transpose All Chords</label>
                                    <div class="flex items-center gap-2 justify-end">
                                        <button id="transposeDownBtn" class="btn btn-secondary btn-sm">-</button>
                                        <span id="transposeStatus" class="font-bold text-lg w-8 text-center">0</span>
                                        <button id="transposeUpBtn" class="btn btn-secondary btn-sm">+</button>
                                    </div>
                                </div>
                                <div class="pt-2">
                                    <label class="block text-sm font-medium text-gray-400 mb-1">Sounding Key</label>
                                    <div id="soundingKeyDisplay" class="sounding-key-box">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
            <div class="md:col-span-3 space-y-4">
                <input type="text" id="titleInput" class="form-input text-xl" placeholder="Song Title">
                <input type="text" id="artistInput" class="form-input" placeholder="Artist Name">
                
                <div id="audioSection" class="p-4 bg-gray-900 rounded-md space-y-3">
                    <h3 class="text-lg font-semibold">Voice Memo</h3>
                     <p class="text-sm text-gray-400">Recording is a premium feature. Sign up to enable audio memos.</p>
                    <div class="flex items-center gap-4">
                        <button id="recordBtn" class="btn btn-record" disabled>Record</button>
                        <button id="stopBtn" class="btn btn-secondary" disabled>Stop</button>
                        <span id="recordingStatus" class="text-gray-400"></span>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-2">Live Preview</h3>
                    <div id="livePreview" class="live-preview min-h-[100px] overflow-x-auto"></div>
                </div>
                
                <div class="mb-2">
                    <label class="block text-sm font-medium text-gray-400 mb-1">Chord Queue (Click in a lyrics block to place)</label>
                    <div class="flex items-center gap-2 p-2 bg-gray-900 rounded-md min-h-[40px]">
                        <div id="chordQueue" class="flex flex-wrap gap-2 flex-grow"></div>
                        <button id="clearQueueBtn" class="btn btn-danger btn-sm">Clear</button>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-2">Song Builder</h3>
                    <div id="song-blocks-container" class="space-y-4"></div>
                    <div id="add-block-buttons" class="mt-4 flex flex-wrap gap-2"></div>
                </div>
            </div>
        </main>
    </div>
    
    <div id="fret-selection-modal" class="hidden fixed z-50 bg-gray-800 border border-gray-600 rounded-lg shadow-xl p-4 space-y-2">
        <label for="fret-number-selector" class="text-sm text-gray-300">Select Fret:</label>
        <select id="fret-number-selector" class="form-select text-sm w-full"></select>
        <div class="flex justify-end gap-2">
            <button id="cancel-fret-btn" class="btn btn-secondary btn-sm">Cancel</button>
            <button id="add-fret-btn" class="btn btn-primary btn-sm">Add</button>
        </div>
    </div>

    <div id="import-modal" class="modal-overlay hidden">
        <div class="modal-content space-y-4">
            <h2 class="text-2xl font-bold">Import Song</h2>
            <p class="text-sm text-gray-400">
                Paste your song text below. The tool will try to automatically identify sections.
                For best results, place section headers like <code class="bg-gray-700 p-1 rounded">[Verse]</code> or <code class="bg-gray-700 p-1 rounded">Chorus:</code> on their own lines.
            </p>
            <textarea id="import-textarea" class="form-textarea w-full" rows="15" placeholder="Paste your song here..."></textarea>
            <div class="flex justify-end gap-4">
                <button id="import-cancel-btn" class="btn btn-secondary">Cancel</button>
                <button id="import-confirm-btn" class="btn btn-primary">Import</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });
        
        function initializeApp() {
            let songData = {}; 
            let chordQueue = [];
            let chordQueueIndex = 0;
            let lastFocusedLyricsBlock = null;
            let fretSelectionContext = { blockId: null, string: null, position: null };
            let selectedNote = { blockId: null, noteIndex: null };
            let activeResize = { element: null, startY: 0, startHeight: 0 };
            let isDraggingNote = false;

            const titleInput = document.getElementById('titleInput');
            const artistInput = document.getElementById('artistInput');
            const songBlocksContainer = document.getElementById('song-blocks-container');
            const addBlockButtonsContainer = document.getElementById('add-block-buttons');
            const livePreview = document.getElementById('livePreview');
            const tuningSelector = document.getElementById('tuningSelector');
            const capoFretInput = document.getElementById('capoFretInput');
            const saveBtn = document.getElementById('saveBtn');
            const resetDemoBtn = document.getElementById('resetDemoBtn');
            const statusMessage = document.getElementById('statusMessage');
            const chordPalette = document.querySelector('#sidebar #chordPalette');
            const transposeDownBtn = document.getElementById('transposeDownBtn');
            const transposeUpBtn = document.getElementById('transposeUpBtn');
            const transposeStatus = document.getElementById('transposeStatus');
            const chordQueueDiv = document.getElementById('chordQueue');
            const clearQueueBtn = document.getElementById('clearQueueBtn');

            const fretSelectionModal = document.getElementById('fret-selection-modal');
            const fretNumberSelector = document.getElementById('fret-number-selector');
            const addFretBtn = document.getElementById('add-fret-btn');
            const cancelFretBtn = document.getElementById('cancel-fret-btn');
            const soundingKeyDisplay = document.getElementById('soundingKeyDisplay');

            const importBtn = document.getElementById('importBtn');
            const importModal = document.getElementById('import-modal');
            const importTextarea = document.getElementById('import-textarea');
            const importConfirmBtn = document.getElementById('import-confirm-btn');
            const importCancelBtn = document.getElementById('import-cancel-btn');
            
            const TUNINGS = { 
                E_STANDARD: { name: "E Standard", offset: 0, strings: ['e', 'B', 'G', 'D', 'A', 'E'] }, 
                EB_STANDARD: { name: "Eb Standard", offset: -1, strings: ['d#', 'A#', 'F#', 'C#', 'G#', 'D#'] }, 
                D_STANDARD: { name: "D Standard", offset: -2, strings: ['d', 'A', 'F', 'C', 'G', 'D'] }, 
                DROP_D: { name: "Drop D", offset: 0, strings: ['e', 'B', 'G', 'D', 'A', 'D'] }, 
                DROP_C: { name: "Drop C", offset: -2, strings: ['d', 'A', 'F', 'C', 'G', 'C'] } 
            };
            const STRING_CONFIG = { 6: { height: 180, stringSpacing: 28 }, 7: { height: 210, stringSpacing: 28 }, 8: { height: 240, stringSpacing: 28 } };
            const FRETBOARD_CONFIG = { frets: 24, width: 8000, nutWidth: 15, fretSpacing: 80, dotFrets: [3, 5, 7, 9, 12, 15, 17, 19, 21, 24], dotRadius: 5, noteRadius: 11 };
            const sharpScale = ['A', 'A#', 'B', 'C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#'];
            
            function updateMusicalSettingsUI() {
                tuningSelector.value = songData.tuning;
                capoFretInput.value = songData.capo;
                const steps = songData.transpose;
                transposeStatus.textContent = steps > 0 ? `+${steps}` : steps;
            }

            function initializeDemoSong() {
                songData = { 
                    id: 'demo-song', 
                    title: 'The ProAnthem Feature Tour', 
                    artist: 'The Dev Team', 
                    audio_url: null, 
                    song_blocks: [
                        { id: 'block_1', type: 'lyrics', label: 'Lyrics & Chords', content: '[G]Just type your lyrics [D]in this space,\nPut [Em]chords in brackets, [C]right in place.\nThe [G]preview updates, [D]as you go,\nA [C]perfect layout for your [G]show.', height: 140 },
                        { id: 'block_2', type: 'lyrics', label: 'Interactive Tabs', content: '[G]Below this block, a [D]fretboard lies,\nClick [Em]any string, a [C]note will rise.\nThen [G]drag and drop to [D]find your sound,\nThe [C]cleanest tabs you\'ve ever [G]found.', height: 140 },
                        { id: 'block_3', type: 'tab', label: 'Guitar Riff Example', strings: 6, data: { notes: [
                            {string: 3, fret: 5, position: 200}, {string: 3, fret: 7, position: 350},
                            {string: 2, fret: 5, position: 500}, {string: 2, fret: 7, position: 650},
                        ]}, editMode: false },
                        { id: 'block_4', type: 'lyrics', label: 'Musical Settings', content: '[Am]Is the key too high? [G]Feeling strained?\nUse the [C]Transpose buttons, [F]no song\'s chained.\nAdd a [Am]capo, change the [G]tuning too,\nThe [F]sidebar settings [E7]work for you.', height: 140 },
                        { id: 'block_5', type: 'lyrics', label: 'The Song Builder', content: '[C]Need another verse? A [G]bridge or two?\nThe [Am]"Add Section" buttons [F]wait for you.\nThen [C]grab the header, [G]drag and drop,\nArrange your song, right [C]from the top.', height: 140 },
                        { id: 'block_6', type: 'lyrics', label: 'Save & Sign Up (Outro)', content: '[G]This is a demo, [D]please be aware,\nYour [Em]masterpiece won\'t [C]save from here.\nFor [G]setlists, voice memos, and [D]cloud-based drive,\nJust [C]sign on up and watch your music [G]thrive!', height: 140 }
                    ],
                    tuning: 'E_STANDARD', capo: 0, transpose: 0
                };
                
                titleInput.value = songData.title;
                artistInput.value = songData.artist;
                
                updateMusicalSettingsUI();
                renderSongBlocks();
                updateSoundingKey();
                setStatus('Demo loaded. Your changes will not be saved.');
            }
            
            function handleSave() {
                setStatus('Saving is disabled in the demo.', true);
            }

            function loadDemoChords() {
                const demoChords = ['A', 'Am', 'B', 'C', 'Cmaj7', 'D', 'Dm', 'E', 'Em', 'E7', 'F', 'G'];
                chordPalette.innerHTML = '';
                demoChords.forEach(cName => {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-secondary btn-sm';
                    btn.textContent = cName;
                    btn.onclick = (e) => {
                        if (e.ctrlKey || e.metaKey) {
                            chordQueue.push(cName); renderChordQueue();
                        } else if (lastFocusedLyricsBlock) {
                            const t = `[${cName}]`; const p = lastFocusedLyricsBlock.selectionStart;
                            lastFocusedLyricsBlock.value = lastFocusedLyricsBlock.value.slice(0, p) + t + lastFocusedLyricsBlock.value.slice(p);
                            lastFocusedLyricsBlock.focus(); lastFocusedLyricsBlock.setSelectionRange(p + t.length, p + t.length);
                            updateBlockData(lastFocusedLyricsBlock.closest('.song-block').dataset.blockId, 'content', lastFocusedLyricsBlock.value);
                        }
                    };
                    chordPalette.appendChild(btn);
                });
            }

            // --- IMPROVED: Advanced Song Parser Logic ---
            function parsePastedSong(text) {
                let metadata = { capo: 0, tuning: 'E_STANDARD' };
                let lines = text.split('\n');
                
                // 1. Pre-process to extract metadata and remove junk lines
                lines = lines.filter(line => {
                    const capoMatch = line.match(/capo\s+(\d+)/i);
                    if (capoMatch) {
                        metadata.capo = parseInt(capoMatch[1], 10);
                        return false; // Remove line
                    }
                    const tuningMatch = line.match(/tuning/i);
                    if (tuningMatch) {
                        if(line.toLowerCase().includes('eb') || line.toLowerCase().includes('e flat')) metadata.tuning = 'EB_STANDARD';
                        else if(line.toLowerCase().includes('drop d')) metadata.tuning = 'DROP_D';
                        else if(line.toLowerCase().includes('d standard')) metadata.tuning = 'D_STANDARD';
                        else if(line.toLowerCase().includes('drop c')) metadata.tuning = 'DROP_C';
                        // Add more tuning detections here if needed
                        return false; // Remove line
                    }
                    if (line.match(/^Page \d+\/\d+$/i)) {
                        return false; // Remove junk page markers
                    }
                    return true;
                });

                const newBlocks = [];
                let currentBlock = null;

                const headerRegex = /^\s*(?:\[([^\]]+)\]|(intro|verse|chorus|bridge|pre-chorus|solo|outro|tag)[\s\d:]*)\s*$/i;
                const tabLineRegex = /^\s*([a-zA-Z]\||[\|gteADGBCF]).*[\d\-xphb/\\~]/;
                const chordLineRegex = /^\s*([A-G][b#]?(?:m|maj|sus|dim|add|aug|m7|7)?[0-9]*(?:\/[A-G][b#]?)?\s*)+$/;

                const pushBlock = () => {
                    if (currentBlock && currentBlock.content.trim()) {
                        currentBlock.content = currentBlock.content.trim();
                        newBlocks.push(currentBlock);
                    }
                };
                
                const createNewBlock = (label, type) => {
                    pushBlock();
                    const capitalizedLabel = label.charAt(0).toUpperCase() + label.slice(1);
                    currentBlock = {
                        id: `block_${Date.now()}_${newBlocks.length}`,
                        label: capitalizedLabel || 'Section',
                        type: type,
                        content: '',
                        height: 120
                    };
                };

                let sectionLines = [];
                for (const line of lines) {
                    const headerMatch = line.match(headerRegex);
                    if (headerMatch) {
                        processSectionLines(sectionLines);
                        sectionLines = [];
                        const label = (headerMatch[1] || headerMatch[2] || 'Section').trim();
                        createNewBlock(label, 'lyrics');
                    } else {
                        sectionLines.push(line);
                    }
                }
                processSectionLines(sectionLines);
                pushBlock();
                
                function processSectionLines(blockLines) {
                    if (!currentBlock) createNewBlock('Verse 1', 'lyrics');
                    if (blockLines.some(l => l.match(tabLineRegex))) {
                        currentBlock.type = 'tab';
                    }

                    if (currentBlock.type === 'lyrics') {
                        let mergedContent = [];
                        for (let i = 0; i < blockLines.length; i++) {
                            const currentLine = blockLines[i];
                            const nextLine = (i + 1 < blockLines.length) ? blockLines[i+1] : null;

                            if (currentLine.match(chordLineRegex) && nextLine && nextLine.trim() !== '') {
                                // This is a chord line followed by a lyric line, so merge them
                                mergedContent.push(mergeChordLyricLines(currentLine, nextLine));
